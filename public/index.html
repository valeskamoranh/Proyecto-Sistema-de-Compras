<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Login - Sistema de Compras</title>
    <link rel="stylesheet" href="vistas/css/styles.css" />
    <style>
      .password-container {
        position: relative;
        display: flex;
        align-items: center;
      }
      .toggle-password {
        position: absolute;
        right: 10px;
        cursor: pointer;
        font-size: 0.8em;
        color: #666;
        user-select: none;
      }
      .toggle-password:hover {
        color: #333;
      }

      /* Estilo para mensaje de error global */
      #mensaje-servidor {
        color: #d63031;
        text-align: center;
        margin-top: 10px;
        font-weight: bold;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Iniciar Sesión</h2>

      <form id="form-login" novalidate>
        <div class="form-group">
          <label for="txt_usuario">Usuario </label>
          <input
            type="text"
            id="txt_usuario"
            name="usuario"
            maxlength="10"
            placeholder="Ingrese su cédula"
            required
          />
          <div id="error_usuario" class="error-msg"></div>
        </div>

        <div class="form-group">
          <label for="txt_password">Contraseña</label>
          <div class="password-container">
            <input
              type="password"
              id="txt_password"
              name="password"
              placeholder="Ingrese su contraseña"
              required
            />
            <span class="toggle-password" onclick="verPassword()">Mostrar</span>
          </div>
          <div id="error_password" class="error-msg"></div>
        </div>

        <div id="mensaje-servidor"></div>

        <button class="btn-guardar" type="submit">Ingresar</button>
      </form>
    </div>

    <script src="vistas/js/validaciones.js"></script>

    <script>
      document
        .getElementById("form-login")
        .addEventListener("submit", function (e) {
          e.preventDefault(); 
          validarLogin(); 
        });

      async function validarLogin() {
        limpiarErrores();
        document.getElementById("mensaje-servidor").style.display = "none";

        let esValido = true;
        const usuario = document.getElementById("txt_usuario").value.trim();
        const password = document.getElementById("txt_password").value.trim();

        // 1. VALIDACIONES 
        if (esVacio(usuario)) {
          mostrarError(
            "txt_usuario",
            "error_usuario",
            "El usuario es obligatorio.",
          );
          esValido = false;
        } else if (!esCedulaEcuatoriana(usuario)) {
          mostrarError(
            "txt_usuario",
            "error_usuario",
            "Ingrese una cédula válida.",
          );
          esValido = false;
        }

        if (esVacio(password)) {
          mostrarError(
            "txt_password",
            "error_password",
            "La contraseña es obligatoria.",
          );
          esValido = false;
        } else if (!cumpleLongitudMinima(password, 6)) {
          mostrarError(
            "txt_password",
            "error_password",
            "Contraseña incorrecta (mínimo 6 caracteres).",
          );
          esValido = false;
        }

        if (!esValido) return;

        // 2. CONEXIÓN CON BASE DE DATOS
        try {
          const respuesta = await fetch("/api/usuarios/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cedula: usuario }),
          });

          const data = await respuesta.json();

          if (respuesta.ok) {
            window.location.href = "./vistas/formularios/menu_principal.html";
          } else {
            const msgDiv = document.getElementById("mensaje-servidor");
            msgDiv.innerText = data.mensaje || "Acceso denegado.";
            msgDiv.style.display = "block";
          }
        } catch (error) {
          console.error(error);
          alert("Error de conexión con el servidor.");
        }
      }

      function verPassword() {
        const input = document.getElementById("txt_password");
        const texto = document.querySelector(".toggle-password");
        if (input.type === "password") {
          input.type = "text";
          texto.textContent = "Ocultar";
        } else {
          input.type = "password";
          texto.textContent = "Mostrar";
        }
      }
    </script>
  </body>
</html>
