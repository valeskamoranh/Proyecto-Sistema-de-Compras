<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Listado de Cotizaciones</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <style>
    body {
      background-color: #f8f9fa;
      font-family: "Segoe UI", sans-serif;
    }
  </style>
</head>

<body>
  <a href="../formularios/menu_principal.html" class="btn-regresar">‚¨Ö Regresar</a>

  <div class="container" style="max-width: 1100px">
    <h1 style="color: #4a148c">Cotizaciones Registradas</h1>

    <div class="busqueda-container" style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
      <div class="busqueda-input-wrapper"
        style="position: relative; display: flex; align-items: center; background: white; border: 1px solid #dfe6e9; border-radius: 8px; padding: 0 12px; width: 300px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#636e72" stroke-width="2"
          style="margin-right: 8px;">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" id="buscador" placeholder="Buscar por N¬∞, Proveedor o N¬∞ Requisici√≥n..."
          onkeyup="filtrarTabla()" style="border: none; padding: 10px 0; outline: none; width: 100%;">
      </div>
    </div>

    <table id="tabla-listado">
      <thead>
        <tr>
          <th>N¬∞ COT</th>
          <th>Fecha</th>
          <th>Proveedor</th>
          <th>Req. Asociada</th>
          <th>Validez (D√≠as)</th>
          <th>Monto Total</th>
          <th>Items</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="lista-cotizaciones"></tbody>
    </table>
  </div>

  <div id="modal-detalle" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="cerrarModal()">&times;</span>

      <h2 id="modal-titulo" style="color: #5e2a84; margin-bottom: 10px">
        Detalle de Cotizaci√≥n
      </h2>
      <hr style="border: 0; border-top: 1px solid #eee; margin-bottom: 20px" />

      <div id="modal-info-general" style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
            font-size: 1.1em;
          "></div>

      <table style="
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
          ">
        <thead style="background: #f3f0fc; color: #5e2a84">
          <tr>
            <th style="padding: 10px; text-align: left">Producto</th>
            <th>Cant.</th>
            <th>Precio Unit.</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="modal-tabla-cuerpo"></tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", cargarCotizaciones);

    async function cargarCotizaciones() {
      try {
        const res = await fetch("/api/cotizaciones");
        const datos = await res.json();
        const tbody = document.getElementById("lista-cotizaciones");
        tbody.innerHTML = "";

        if (datos.length === 0) {
          tbody.innerHTML =
            "<tr><td colspan='8'>No hay cotizaciones registradas.</td></tr>";
          return;
        }

        datos.forEach((c) => {
          const monto = parseFloat(c.monto_total).toFixed(2);

          tbody.innerHTML += `
                <tr>
                    <td><strong>${c.id_cotizacion}</strong></td>
                    <td>${new Date(c.fecha_cotizacion).toLocaleDateString()}</td>
                    <td>${c.nombre_proveedor || "N/A"}</td>
                    <td>#${c.id_requisicion}</td>
                    <td>${c.validez}</td>
                    <td style="font-weight: bold; color: #2e86de;">$${monto}</td>
                    <td>${c.cantidad_items}</td>
                    <td>
                        <button class="btn-ver" onclick="verDetalle(${c.id_cotizacion})" title="Ver Detalle">Ver</button>
                        <button class="btn-edit" onclick="editarCotizacion(${c.id_cotizacion})" title="Editar">‚úèÔ∏è</button>
                        <button class="btn-delete" onclick="eliminarCotizacion(${c.id_cotizacion})" title="Eliminar">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });
      } catch (error) {
        console.error(error);
        alert("Error al cargar cotizaciones.");
      }
    }

    // Funci√≥n para redirigir al formulario de edici√≥n
    function editarCotizacion(id) {
      window.location.href = `registrar_cotizacion.html?id=${id}`;
    }

    // Funci√≥n de b√∫squeda en tiempo real
    function filtrarTabla() {
      const input = document.getElementById("buscador");
      const filtro = input.value.toUpperCase();
      const tabla = document.getElementById("tabla-listado");
      const tr = tabla.getElementsByTagName("tr");

      for (let i = 1; i < tr.length; i++) {
        const tdId = tr[i].getElementsByTagName("td")[0];
        const tdProv = tr[i].getElementsByTagName("td")[2];
        const tdReq = tr[i].getElementsByTagName("td")[3];

        if (tdId || tdProv || tdReq) {
          const textoId = tdId.textContent || tdId.innerText;
          const textoProv = tdProv.textContent || tdProv.innerText;
          const textoReq = tdReq.textContent || tdReq.innerText;

          if (textoId.toUpperCase().indexOf(filtro) > -1 ||
            textoProv.toUpperCase().indexOf(filtro) > -1 ||
            textoReq.toUpperCase().indexOf(filtro) > -1) {
            tr[i].style.display = "";
          } else {
            tr[i].style.display = "none";
          }
        }
      }
    }

    async function verDetalle(id) {
      try {
        const res = await fetch(`/api/cotizaciones/${id}`);
        if (!res.ok) throw new Error("Error al obtener detalle.");

        const data = await res.json();

        // 1. Llenar Cabecera Modal
        document.getElementById("modal-titulo").innerText =
          `Cotizaci√≥n N¬∞ ${data.id_cotizacion}`;
        document.getElementById("modal-info-general").innerHTML = `
            <div><strong>Fecha:</strong> ${new Date(data.fecha_cotizacion).toLocaleDateString()}</div>
            <div><strong>Proveedor:</strong> ${data.nombre_proveedor}</div>
            <div><strong>Validez:</strong> ${data.validez} d√≠as</div>
            <div><strong>Monto Total:</strong> $${parseFloat(data.monto_total).toFixed(2)}</div>
            <div><strong>Basada en Requisici√≥n:</strong> #${data.id_requisicion}</div>
          `;

        // 2. Llenar Tabla Detalles
        const tbody = document.getElementById("modal-tabla-cuerpo");
        tbody.innerHTML = "";

        data.detalles.forEach((d) => {
          const precio = parseFloat(d.precio_unitario);
          const subtotal = d.cantidad * precio;

          tbody.innerHTML += `
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px; text-align: left;">${d.nombre_producto}</td>
                    <td style="text-align: center;">${d.cantidad}</td>
                    <td style="text-align: center;">$${precio.toFixed(2)}</td>
                    <td style="text-align: center; font-weight: bold;">$${subtotal.toFixed(2)}</td>
                </tr>
            `;
        });

        document.getElementById("modal-detalle").style.display = "block";
      } catch (error) {
        alert("Error: " + error.message);
      }
    }

    async function eliminarCotizacion(id) {
      if (
        !confirm(
          `¬øEst√°s seguro de ELIMINAR la Cotizaci√≥n N¬∞ ${id} permanentemente?`,
        )
      )
        return;

      try {
        const res = await fetch(`/api/cotizaciones/${id}`, {
          method: "DELETE",
        });
        const result = await res.json();
        if (res.ok) {
          alert(result.mensaje);
          cargarCotizaciones();
        } else {
          alert(result.mensaje);
        }
      } catch (error) {
        alert("Error de conexi√≥n");
      }
    }

    function cerrarModal() {
      document.getElementById("modal-detalle").style.display = "none";
    }

    window.onclick = function (e) {
      if (e.target == document.getElementById("modal-detalle")) cerrarModal();
    };
  </script>
</body>

</html>