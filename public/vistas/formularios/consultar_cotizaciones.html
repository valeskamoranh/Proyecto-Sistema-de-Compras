<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Listado de Cotizaciones</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <style>
      body {
        background-color: #f8f9fa;
        font-family: "Segoe UI", sans-serif;
      }

      #tabla-listado {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      #tabla-listado th {
        background-color: #f3f0fc; 
        color: #5e2a84; 
        padding: 12px;
        text-align: center;
        text-transform: uppercase;
        font-size: 0.9em;
      }
      #tabla-listado td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        text-align: center;
        color: #444;
      }

      .btn-ver {
        background-color: #0984e3;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
      }
      .btn-delete {
        background: #d63031;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 25px;
        border-radius: 10px;
        width: 60%;
        max-width: 800px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }
      .close-btn {
        float: right;
        cursor: pointer;
        font-size: 28px;
        font-weight: bold;
        color: #aaa;
      }
      .close-btn:hover {
        color: #000;
      }
    </style>
  </head>
  <body>
    <a href="../formularios/menu_principal.html" class="btn-regresar"
      >‚¨Ö Regresar</a
    >

    <div class="container" style="max-width: 1100px">
      <h1 style="color: #4a148c">Cotizaciones Registradas</h1>

      <table id="tabla-listado">
        <thead>
          <tr>
            <th>N¬∞ COT</th>
            <th>Fecha</th>
            <th>Proveedor</th>
            <th>Req. Asociada</th>
            <th>Validez (D√≠as)</th>
            <th>Monto Total</th>
            <th>Items</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="lista-cotizaciones"></tbody>
      </table>
    </div>

    <div id="modal-detalle" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="cerrarModal()">&times;</span>

        <h2 id="modal-titulo" style="color: #5e2a84; margin-bottom: 10px">
          Detalle de Cotizaci√≥n
        </h2>
        <hr
          style="border: 0; border-top: 1px solid #eee; margin-bottom: 20px"
        />

        <div
          id="modal-info-general"
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
            font-size: 1.1em;
          "
        ></div>

        <table
          style="
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
          "
        >
          <thead style="background: #f3f0fc; color: #5e2a84">
            <tr>
              <th style="padding: 10px; text-align: left">Producto</th>
              <th>Cant.</th>
              <th>Precio Unit.</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody id="modal-tabla-cuerpo"></tbody>
        </table>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", cargarCotizaciones);

      async function cargarCotizaciones() {
        try {
          const res = await fetch("/api/cotizaciones");
          const datos = await res.json();
          const tbody = document.getElementById("lista-cotizaciones");
          tbody.innerHTML = "";

          if (datos.length === 0) {
            tbody.innerHTML =
              "<tr><td colspan='8'>No hay cotizaciones registradas.</td></tr>";
            return;
          }

          datos.forEach((c) => {
            const monto = parseFloat(c.monto_total).toFixed(2);

            tbody.innerHTML += `
                <tr>
                    <td><strong>${c.id_cotizacion}</strong></td>
                    <td>${new Date(c.fecha_cotizacion).toLocaleDateString()}</td>
                    <td>${c.nombre_proveedor || "N/A"}</td>
                    <td>#${c.id_requisicion}</td>
                    <td>${c.validez}</td>
                    <td style="font-weight: bold; color: #2e86de;">$${monto}</td>
                    <td>${c.cantidad_items}</td>
                    <td>
                        <button class="btn-ver" onclick="verDetalle(${c.id_cotizacion})">Ver</button>
                        <button class="btn-delete" onclick="eliminarCotizacion(${c.id_cotizacion})">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
          });
        } catch (error) {
          console.error(error);
          alert("Error al cargar cotizaciones.");
        }
      }

      async function verDetalle(id) {
        try {
          const res = await fetch(`/api/cotizaciones/${id}`);
          if (!res.ok) throw new Error("Error al obtener detalle.");

          const data = await res.json();

          // 1. Llenar Cabecera Modal
          document.getElementById("modal-titulo").innerText =
            `Cotizaci√≥n N¬∞ ${data.id_cotizacion}`;
          document.getElementById("modal-info-general").innerHTML = `
            <div><strong>Fecha:</strong> ${new Date(data.fecha_cotizacion).toLocaleDateString()}</div>
            <div><strong>Proveedor:</strong> ${data.nombre_proveedor}</div>
            <div><strong>Validez:</strong> ${data.validez} d√≠as</div>
            <div><strong>Monto Total:</strong> $${parseFloat(data.monto_total).toFixed(2)}</div>
            <div><strong>Basada en Requisici√≥n:</strong> #${data.id_requisicion}</div>
          `;

          // 2. Llenar Tabla Detalles
          const tbody = document.getElementById("modal-tabla-cuerpo");
          tbody.innerHTML = "";

          data.detalles.forEach((d) => {
            const precio = parseFloat(d.precio_unitario);
            const subtotal = d.cantidad * precio;

            tbody.innerHTML += `
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px; text-align: left;">${d.nombre_producto}</td>
                    <td style="text-align: center;">${d.cantidad}</td>
                    <td style="text-align: center;">$${precio.toFixed(2)}</td>
                    <td style="text-align: center; font-weight: bold;">$${subtotal.toFixed(2)}</td>
                </tr>
            `;
          });

          document.getElementById("modal-detalle").style.display = "block";
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      async function eliminarCotizacion(id) {
        if (
          !confirm(
            `¬øEst√°s seguro de ELIMINAR la Cotizaci√≥n N¬∞ ${id} permanentemente?`,
          )
        )
          return;

        try {
          const res = await fetch(`/api/cotizaciones/${id}`, {
            method: "DELETE",
          });
          const result = await res.json();
          if (res.ok) {
            alert("" + result.mensaje);
            cargarCotizaciones();
          } else {
            alert("Error: " + result.mensaje);
          }
        } catch (error) {
          alert("Error de conexi√≥n");
        }
      }

      function cerrarModal() {
        document.getElementById("modal-detalle").style.display = "none";
      }

      window.onclick = function (e) {
        if (e.target == document.getElementById("modal-detalle")) cerrarModal();
      };
    </script>
  </body>
</html>
