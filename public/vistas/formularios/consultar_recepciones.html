<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Historial de Recepciones</title>
  <link rel="stylesheet" href="../css/styles.css" />
</head>

<body>
  <a href="../formularios/menu_principal.html" class="btn-regresar">‚¨Ö Regresar</a>

  <div class="container" style="max-width: 1000px">
    <h1 style="color: #4a148c;">Recepciones en Bodega</h1>

    <div class="busqueda-container" style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
      <div class="busqueda-input-wrapper"
        style="position: relative; display: flex; align-items: center; background: white; border: 1px solid #dfe6e9; border-radius: 8px; padding: 0 12px; width: 300px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#636e72" stroke-width="2"
          style="margin-right: 8px;">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" id="buscador" placeholder="Buscar por N¬∞ Recepci√≥n, Orden de Compra o Estado..."
          onkeyup="filtrarTabla()" style="border: none; padding: 10px 0; outline: none; width: 100%;">
      </div>
    </div>

    <table id="tabla-listado">
      <thead>
        <tr>
          <th>N¬∞ Recep</th>
          <th>Fecha</th>
          <th>Ref. Orden Compra</th>
          <th>Observaciones</th>
          <th>Items</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="lista-recepciones"></tbody>
    </table>
  </div>

  <div id="modal-detalle" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="cerrarModal()">&times;</span>
      <h2 id="modal-titulo" style="color: #5e2a84;">Detalle de Recepci√≥n</h2>
      <hr style="border: 0; border-top: 1px solid #eee; margin-bottom: 20px;" />

      <div id="modal-info-general"
        style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
      </div>

      <table style="width: 100%; border-collapse: collapse;">
        <thead style="background: #f3f0fc; color: #5e2a84">
          <tr>
            <th style="padding: 10px; text-align: left;">Producto</th>
            <th>Unidad</th>
            <th>Cant. Recibida</th>
          </tr>
        </thead>
        <tbody id="modal-tabla-cuerpo"></tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", cargarRecepciones);

    async function cargarRecepciones() {
      try {
        const res = await fetch("/api/recepciones");
        const datos = await res.json();
        const tbody = document.getElementById("lista-recepciones");
        tbody.innerHTML = "";

        datos.forEach((r) => {
          const statusClass = `estado-${r.estado_recepcion.toLowerCase()}`;

          tbody.innerHTML += `
                <tr>
                    <td><strong>${r.id_recepcion}</strong></td>
                    <td>${new Date(r.fecha_recepcion).toLocaleDateString()}</td>
                    <td><a href="#" style="color:#6c5ce7; font-weight:bold;">#${r.id_OC}</a></td>
                    <td><small>${r.observaciones || 'Sin obs.'}</small></td>
                    <td>${r.cantidad_items}</td>
                    <td><span class="badge ${statusClass}">${r.estado_recepcion}</span></td>
                    <td class="acciones-container">
                        <button class="btn-ver" onclick="verDetalle(${r.id_recepcion})">Ver</button>
                        <button class="btn-delete" onclick="eliminarRecepcion(${r.id_recepcion})">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        });
      } catch (error) { console.error(error); }
    }

    function filtrarTabla() {
      const input = document.getElementById("buscador");
      const filtro = input.value.toUpperCase();
      const tabla = document.getElementById("tabla-listado");
      const tr = tabla.getElementsByTagName("tr");

      for (let i = 1; i < tr.length; i++) {
        const tdId = tr[i].getElementsByTagName("td")[0];
        const tdOC = tr[i].getElementsByTagName("td")[2];
        const tdEstado = tr[i].getElementsByTagName("td")[5];

        if (tdId || tdOC || tdEstado) {
          const textoId = tdId.textContent || tdId.innerText;
          const textoOC = tdOC.textContent || tdOC.innerText;
          const textoEstado = tdEstado.textContent || tdEstado.innerText;

          if (
            textoId.toUpperCase().indexOf(filtro) > -1 ||
            textoOC.toUpperCase().indexOf(filtro) > -1 ||
            textoEstado.toUpperCase().indexOf(filtro) > -1
          ) {
            tr[i].style.display = "";
          } else {
            tr[i].style.display = "none";
          }
        }
      }
    }

    async function verDetalle(id) {
      try {
        const res = await fetch(`/api/recepciones/${id}`);
        if (!res.ok) throw new Error("Error obteniendo datos");
        const data = await res.json();

        // Llenar cabecera
        document.getElementById("modal-titulo").innerText = `Recepci√≥n N¬∞ ${data.id_recepcion}`;
        document.getElementById("modal-info-general").innerHTML = `
            <div><strong>Orden Compra:</strong> #${data.id_OC}</div>
            <div><strong>Fecha:</strong> ${new Date(data.fecha_recepcion).toLocaleDateString()}</div>
            <div><strong>Estado:</strong> ${data.estado_recepcion}</div>
            <div><strong>Obs:</strong> ${data.observaciones || '-'}</div>
          `;

        // Llenar tabla detalle
        const tbody = document.getElementById("modal-tabla-cuerpo");
        tbody.innerHTML = "";

        data.detalles.forEach((d) => {
          tbody.innerHTML += `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">${d.nombre_producto}</td>
                    <td style="text-align: center;">${d.unidad_medida}</td>
                    <td style="text-align: center; font-weight: bold; color: #2d3436;">${d.cantidad_recibida}</td>
                </tr>
            `;
        });

        document.getElementById("modal-detalle").style.display = "block";
      } catch (error) { alert("Error: " + error.message); }
    }

    async function eliminarRecepcion(id) {
      if (!confirm(`¬øEliminar el registro de recepci√≥n N¬∞ ${id}?`)) return;
      try {
        const res = await fetch(`/api/recepciones/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (res.ok) {
          alert(result.mensaje);
          cargarRecepciones();
        } else {
          alert(result.mensaje);
        }
      } catch (e) { alert("Error al eliminar"); }
    }

    function cerrarModal() { document.getElementById("modal-detalle").style.display = "none"; }
    window.onclick = function (e) { if (e.target == document.getElementById("modal-detalle")) cerrarModal(); }
  </script>
</body>

</html>