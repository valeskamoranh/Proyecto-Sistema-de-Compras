<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Listado de Requisiciones</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <style>
      #tabla-listado {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
      }
      #tabla-listado th {
        background-color: #f3f0fc; 
        color: #5e2a84; 
        padding: 12px;
        text-align: center;
      }
      #tabla-listado td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        text-align: center;
      }

      /* Badges de estado */
      .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: bold;
      }
      /* 1. Pendiente:  */
      .estado-pendiente {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
      }

      /* 2. Aprobada:  */
      .estado-aprobada {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      /* 3. Rechazada: */
      .estado-rechazada {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      /* 4. En Proceso: */
      .estado-en-proceso {
        background: #cce5ff;
        color: #004085;
        border: 1px solid #b8daff;
      }

      /* 5. Atendida: */
      .estado-atendida {
        background: #d1e7dd;  
        color: #0f5132;       
        border: 1px solid #badbcc;
      }

      .btn-ver {
        background-color: #0984e3;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
      }
      .btn-rechazar {
        background: #ff7675;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-rechazar:disabled {
        background: #dfe6e9;
        cursor: not-allowed;
        opacity: 0.6;
      }
      .btn-aprobar {
        background: #00b894; 
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
      }
      .btn-aprobar:disabled {
        background: #dfe6e9;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <a href="../formularios/menu_principal.html" class="btn-regresar"
      >⬅ Regresar</a
    >

    <div class="container" style="max-width: 1000px">
      <h1 style="color: #4a148c">Requisiciones Registradas</h1>

      <table id="tabla-listado">
        <thead>
          <tr>
            <th>N° Req</th>
            <th>Fecha</th>
            <th>Solicitante</th>
            <th>Justificación</th>
            <th>Items</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="lista-requisiciones"></tbody>
      </table>
    </div>

    <div
      id="modal-detalle"
      class="modal"
      style="
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      "
    >
      <div
        style="
          background-color: white;
          margin: 5% auto;
          padding: 20px;
          border-radius: 8px;
          width: 70%;
          max-width: 800px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        "
      >
        <span
          onclick="cerrarModal()"
          style="
            float: right;
            cursor: pointer;
            font-size: 28px;
            font-weight: bold;
          "
          >&times;</span
        >

        <h2 id="modal-titulo" style="color: #5e2a84">Detalle de Requisición</h2>
        <hr />

        <div
          id="modal-info-general"
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
          "
        ></div>

        <table style="width: 100%; border-collapse: collapse">
          <thead style="background: #f3f0fc; color: #5e2a84">
            <tr>
              <th style="padding: 10px">Producto</th>
              <th>Cantidad</th>
              <th>Unidad Medida</th>
            </tr>
          </thead>
          <tbody id="modal-tabla-cuerpo"></tbody>
        </table>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", cargarRequisiciones);

      async function cargarRequisiciones() {
        try {
          const res = await fetch("/api/requisiciones");
          const requisiciones = await res.json();
          const tbody = document.getElementById("lista-requisiciones");
          tbody.innerHTML = "";

          requisiciones.forEach((r) => {
            const statusClass = `estado-${r.estado.toLowerCase().replace(" ", "-")}`;
            const esRechazable = r.estado === "Pendiente";
            const esGestionable = r.estado === "Pendiente";

            tbody.innerHTML += `
                <tr>
                    <td><strong>${r.id_requisicion}</strong></td>
                    <td>${new Date(r.fecha).toLocaleDateString()}</td>
                    <td>${r.nombre_usuario || "N/A"}</td>
                    <td><small>${r.justificacion || "-"}</small></td>
                    <td>${r.cantidad_items}</td>
                    <td><span class="badge ${statusClass}">${r.estado}</span></td>
                    <td>
                        <button class="btn-ver" onclick="verDetalle(${r.id_requisicion})">Ver</button>
                        <button class="btn-aprobar" 
                                onclick="confirmarAprobacion(${r.id_requisicion})"
                                ${!esGestionable ? "disabled" : ""}
                                title="Aprobar">
                            Aprobar
                        </button>
                        <button class="btn-rechazar" 
                                onclick="confirmarRechazo(${r.id_requisicion})"
                                ${!esRechazable ? "disabled" : ""}
                                title="${esRechazable ? "Rechazar requisición" : "Solo pendientes se pueden rechazar"}">
                            Rechazar
                        </button>
                    </td>
                </tr>
            `;
          });
        } catch (error) {
          console.error("Error cargando requisiciones:", error);
        }
      }

      async function verDetalle(id) {
        try {
          const res = await fetch(`/api/requisiciones/${id}`);
          if (!res.ok) throw new Error("No se pudo obtener el detalle.");

          const data = await res.json();

          document.getElementById("modal-titulo").innerText =
            `Requisición N° ${data.id_requisicion}`;
          document.getElementById("modal-info-general").innerHTML = `
            <p><strong>Fecha:</strong> ${new Date(data.fecha).toLocaleDateString()}</p>
            <p><strong>Estado:</strong> ${data.estado}</p>
            <p><strong>Solicitante:</strong> ${data.nombre_usuario}</p>
            <p><strong>Justificación:</strong> ${data.justificacion}</p>
          `;

          const tbody = document.getElementById("modal-tabla-cuerpo");
          tbody.innerHTML = "";

          data.detalles.forEach((d) => {
            tbody.innerHTML += `
                <tr style="text-align: center; border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">${d.nombre_producto}</td>
                    <td>${d.cantidad}</td>
                    <td>${d.unidad_medida}</td>
                </tr>
            `;
          });

          document.getElementById("modal-detalle").style.display = "block";
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      async function confirmarRechazo(id) {
        if (!confirm(`¿Está seguro de rechazar la Requisición N° ${id}?`))
          return;

        try {
          const res = await fetch(`/api/requisiciones/anular/${id}`, {
            method: "PUT",
          });
          const resultado = await res.json();

          if (res.ok) {
            alert(resultado.mensaje);
            cargarRequisiciones();
          } else {
            alert("Error: " + resultado.mensaje);
          }
        } catch (error) {
          alert("Error de conexión.");
        }
      }

      async function confirmarAprobacion(id) {
        if (!confirm(`¿Confirmar APROBACIÓN de la Requisición N° ${id}?`)) return;

        try {
          const res = await fetch(`/api/requisiciones/aprobar/${id}`, { method: "PUT" });
          const resultado = await res.json();

          if (res.ok) {
            alert("" + resultado.mensaje);
            cargarRequisiciones(); 
          } else {
            alert("Error: " + resultado.mensaje);
          }
        } catch (error) {
          alert("Error de conexión.");
        }
      }
      function cerrarModal() {
        document.getElementById("modal-detalle").style.display = "none";
      }

      window.onclick = function (event) {
        if (event.target == document.getElementById("modal-detalle")) {
          cerrarModal();
        }
      };
    </script>
  </body>
</html>
