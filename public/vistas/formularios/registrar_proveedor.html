<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Gesti√≥n de Proveedores</title>
  <link rel="stylesheet" href="../css/styles.css" />
</head>

<body>
  <a href="../formularios/menu_principal.html" class="btn-regresar">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 12H5M12 19l-7-7 7-7" />
    </svg>
    Regresar al Men√∫ Principal
  </a>
  <form id="form-proveedor" class="container" novalidate>
    <h1 id="titulo-form">Registrar Proveedor</h1>

    <input type="hidden" id="id_proveedor_edit" value="" />

    <div class="form-group">
      <label for="nombre">Nombre comercial o Raz√≥n social</label>
      <input type="text" id="nombre" name="nombre" required />
      <div id="error_nombre" class="error-msg"></div>
    </div>

    <div class="form-group">
      <label for="ruc">RUC</label>
      <input type="text" id="ruc" name="ruc" maxlength="13" required />
      <div id="error_ruc" class="error-msg"></div>
    </div>

    <div class="form-group">
      <label for="email">Correo</label>
      <input type="email" id="email" name="email" />
      <div id="error_email" class="error-msg"></div>
    </div>

    <div class="form-group">
      <label for="telefono">Tel√©fono</label>
      <input type="text" id="telefono" name="telefono" maxlength="15" />
      <div id="error_telefono" class="error-msg"></div>
    </div>

    <div class="grupo-botones">
      <button type="button" class="btn-guardar" onclick="guardarProveedor()">
        <svg viewBox="0 0 24 24" width="20" height="20" style="vertical-align: middle; margin-right: 5px">
          <path fill="currentColor"
            d="M19,21H5V9H19M6,2H18V6H6M17,3H7V5H17M19,2H5A2,2 0 0,0 3,4V20A2,2 0 0,0 5,22H19A2,2 0 0,0 21,20V4A2,2 0 0,0 19,2Z" />
        </svg>
        <span id="texto-boton">Guardar Proveedor</span>
      </button>
      <button type="button" id="btn-cancelar" class="btn-cancelar" onclick="resetForm()" style="display: none">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
          stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        Cancelar Edici√≥n
      </button>
    </div>
  </form>

  <div class="container container-tabla">
    <h1>Listado de Proveedores</h1>

    <div class="busqueda-container">
      <div class="busqueda-input-wrapper">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#636e72" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" id="input-busqueda" placeholder="Buscar por nombre o RUC..." onkeyup="filtrarTabla()" />
      </div>
    </div>

    <table id="tabla-proveedores">
      <thead>
        <tr>
          <th>ID</th>
          <th>Empresa</th>
          <th>RUC</th>
          <th>Tel√©fono</th>
          <th>Email</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="lista-proveedores"></tbody>
    </table>
  </div>

  <script src="../js/validaciones.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", cargarProveedores);

    async function cargarProveedores() {
      try {
        const res = await fetch("/api/proveedores");

        if (!res.ok) throw new Error("Error al conectar con servidor");

        const proveedores = await res.json();
        const tbody = document.getElementById("lista-proveedores");
        tbody.innerHTML = "";

        if (proveedores.length === 0) {
          tbody.innerHTML =
            "<tr><td colspan='6' style='text-align:center'>No hay proveedores registrados</td></tr>";
          return;
        }

        proveedores.forEach((p) => {
          const id = p.id_proveedor || p.ID_PROVEEDOR;
          const nomOriginal = p.nombre || p.NOMBRE || "";

          const nomLimpio = nomOriginal.replace(/"/g, "&quot;");

          const ruc = p.ruc || p.RUC || "";
          const tel = p.telefono || p.TELEFONO || "";
          const email = p.email || p.EMAIL || "";

          tbody.innerHTML += `
                        <tr>
                            <td>${id}</td>
                            <td>${nomOriginal}</td>
                            <td>${ruc}</td>
                            <td>${tel}</td>
                            <td>${email}</td>
                            <td class="acciones">
                              <button class="btn-edit" 
                                data-id="${id}" data-nom="${nomLimpio}" data-ruc="${ruc}" 
                                data-tel="${tel}" data-email="${email}" 
                                onclick="prepararEdicion(this)">‚úèÔ∏è</button>
                              <button class="btn-delete" onclick="eliminarProveedor('${id}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
        });
      } catch (error) {
        console.error("Error al cargar:", error);
      }
    }

    function validarProveedor() {
      limpiarErrores();
      let esValido = true;

      const nombreVal = document.getElementById("nombre").value.trim();
      const rucVal = document.getElementById("ruc").value.trim();
      const emailVal = document.getElementById("email").value.trim();
      const telefonoVal = document.getElementById("telefono").value.trim();

      // --- VALIDAR NOMBRE ---
      if (esVacio(nombreVal)) {
        mostrarError(
          "nombre",
          "error_nombre",
          "La raz√≥n social es obligatoria.",
        );
        esValido = false;
      } else if (nombreVal.length < 3) {
        mostrarError("nombre", "error_nombre", "El nombre es muy corto.");
        esValido = false;
      }

      // --- VALIDAR RUC ---
      if (esVacio(rucVal)) {
        mostrarError("ruc", "error_ruc", "El RUC es obligatorio.");
        esValido = false;
      } else if (!esRucEcuatoriano(rucVal)) {
        mostrarError("ruc", "error_ruc", "El RUC ingresado no es v√°lido.");
        esValido = false;
      }

      // --- VALIDAR EMAIL ---
      if (!esVacio(emailVal) && !esEmailValido(emailVal)) {
        mostrarError("email", "error_email", "Formato de correo inv√°lido.");
        esValido = false;
      }

      // --- VALIDAR TELEFONO (Opcional) ---
      if (!esVacio(telefonoVal)) {
        if (!esSoloNumeros(telefonoVal)) {
          mostrarError(
            "telefono",
            "error_telefono",
            "Solo se permiten n√∫meros.",
          );
          esValido = false;
        } else if (!cumpleLongitudMinima(telefonoVal, 7)) {
          mostrarError(
            "telefono",
            "error_telefono",
            "N√∫mero inv√°lido (m√≠nimo 7 d√≠gitos).",
          );
          esValido = false;
        }
      }

      return esValido;
    }

    async function guardarProveedor() {
      if (!validarProveedor()) return;

      const id = document.getElementById("id_proveedor_edit").value;
      const datos = {
        nombre: document.getElementById("nombre").value.trim(),
        ruc: document.getElementById("ruc").value.trim(),
        telefono: document.getElementById("telefono").value.trim(),
        email: document.getElementById("email").value.trim(),
      };

      const metodo = id ? "PUT" : "POST";
      const url = id ? `/api/proveedores/${id}` : "/api/proveedores";

      try {
        const respuesta = await fetch(url, {
          method: metodo,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos),
        });

        const resultado = await respuesta.json();

        if (respuesta.ok) {
          alert("" + resultado.mensaje);
          resetForm();
          cargarProveedores();
        } else {
          alert("Error: " + resultado.mensaje);
        }
      } catch (error) {
        alert("Error de conexi√≥n con el servidor.");
      }
    }

    function prepararEdicion(btn) {
      const id = btn.dataset.id;
      const nombre = btn.dataset.nom;
      const ruc = btn.dataset.ruc;
      const tel = btn.dataset.tel;
      const email = btn.dataset.email;

      document.getElementById("id_proveedor_edit").value = id;
      document.getElementById("nombre").value = nombre;
      document.getElementById("ruc").value = ruc;
      document.getElementById("telefono").value = tel;
      document.getElementById("email").value = email;

      document.getElementById("titulo-form").innerText =
        "Editando Proveedor #" + id;
      document.getElementById("texto-boton").innerText = "Actualizar Cambios";
      document.getElementById("btn-cancelar").style.display = "inline-flex";
      document.getElementById("form-proveedor").classList.add("editando");

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function resetForm() {
      const formulario = document.getElementById("form-proveedor");
      formulario.reset();
      document.getElementById("id_proveedor_edit").value = "";
      document.getElementById("titulo-form").innerText =
        "Registrar Proveedor";
      document.getElementById("texto-boton").innerText = "Guardar Proveedor";
      document.getElementById("btn-cancelar").style.display = "none";
      formulario.classList.remove("editando");
      if (typeof limpiarErrores === "function") limpiarErrores();
    }

    async function eliminarProveedor(id) {
      if (!confirm("¬øEliminar este proveedor?")) return;
      try {
        const res = await fetch(`/api/proveedores/${id}`, {
          method: "DELETE",
        });
        const data = await res.json();
        if (res.ok) {
          alert("Eliminado");
          cargarProveedores();
        } else {
          alert("" + data.mensaje);
        }
      } catch (e) {
        alert("Error de conexi√≥n");
      }
    }

    function filtrarTabla() {
      const texto = document
        .getElementById("input-busqueda")
        .value.toLowerCase();
      const filas = document.querySelectorAll("#lista-proveedores tr");

      filas.forEach((fila) => {
        const nombre = fila.cells[1].textContent.toLowerCase();
        const ruc = fila.cells[2].textContent.toLowerCase();
        fila.style.display =
          nombre.includes(texto) || ruc.includes(texto) ? "" : "none";
      });
    }
  </script>
</body>

</html>