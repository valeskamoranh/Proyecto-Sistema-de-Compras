<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Registrar Cotizaci贸n</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <style>
      td {
        vertical-align: top;
      }
      td .error-msg {
        font-size: 0.75em;
        margin-top: 2px;
      }
      #monto_total {
        font-weight: bold;
        background-color: #f0f0f0;
      }
    </style>
  </head>
  <body>
    <a href="../formularios/menu_principal.html" class="btn-regresar">
      <svg
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M19 12H5M12 19l-7-7 7-7" />
      </svg>
      Regresar al Men煤 Principal
    </a>
    <form id="form-cotizacion" class="container" novalidate>
      <h1>Registrar Cotizaci贸n</h1>

      <div
        class="form-group"
        style="
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          border: 1px solid #ddd;
        "
      >
        <label for="id_requisicion_search"> Buscar Requisici贸n</label>
        <div class="search-group">
          <input
            type="number"
            id="id_requisicion_search"
            name="id_requisicion"
            required
          />
          <button
            type="button"
            class="btn-search"
            onclick="buscarRequisicion()"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            Cargar Datos
          </button>
        </div>
        <div id="error_requisicion" class="error-msg"></div>
      </div>

      <div class="form-group">
        <label for="id_proveedor">Proveedor</label>
        <select id="id_proveedor" name="id_proveedor" required>
          <option value="">Seleccione un proveedor</option>
        </select>
        <div id="error_proveedor" class="error-msg"></div>
      </div>

      <div class="form-group">
        <label for="fecha_cotizacion">Fecha de Cotizaci贸n</label>
        <input
          type="date"
          id="fecha_cotizacion"
          name="fecha_cotizacion"
          required
        />
        <div id="error_fecha" class="error-msg"></div>
      </div>

      <div class="form-group">
        <label for="validez">Validez de la oferta (D铆as)</label>
        <input type="number" id="validez" name="validez" min="1" required />
        <div id="error_validez" class="error-msg"></div>
      </div>

      <h2>Detalle de Productos</h2>
      <div id="error_tabla" class="error-msg" style="margin-bottom: 10px"></div>

      <table id="tabla-detalle">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Acci贸n</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <input type="text" name="id_producto[]" class="input-texto" required>
              <div class="error-msg"></div>
            </td>
            <td>
              <input
                type="number"
                name="cantidad[]"
                class="input-numero"
                min="1"
                oninput="calcularTotal()"
                required
              />
              <div class="error-msg"></div>
            </td>
            <td>
              <input
                type="number"
                name="precio_unitario[]"
                class="input-numero"
                step="0.01"
                min="0.01"
                oninput="calcularTotal()"
                placeholder="0.00"
                required
              />
              <div class="error-msg"></div>
            </td>
            <td>
              <button type="button" onclick="eliminarFila(this)"></button>
            </td>
          </tr>
        </tbody>
      </table>

      <br /><br />

      <div class="form-group">
        <label for="monto_total">Monto Total ($)</label>
        <input
          type="text"
          id="monto_total"
          name="monto_total"
          value="0.00"
          readonly
        />
        <div id="error_monto_total" class="error-msg"></div>
      </div>

      <button type="button" class="btn-guardar" onclick="guardarCotizacion()">
        <svg
          viewBox="0 0 24 24"
          width="20"
          height="20"
          style="vertical-align: middle; margin-right: 5px"
        >
          <path
            fill="currentColor"
            d="M19,21H5V9H19M6,2H18V6H6M17,3H7V5H17M19,2H5A2,2 0 0,0 3,4V20A2,2 0 0,0 5,22H19A2,2 0 0,0 21,20V4A2,2 0 0,0 19,2Z"
          />
        </svg>
        Guardar Cotizaci贸n
      </button>
    </form>

    <script src="../js/validaciones.js"></script>

    <script>
      let productosCache = [];

      // 1. AL CARGAR LA PGINA: Traer Proveedores y Productos
      document.addEventListener("DOMContentLoaded", async () => {
        await cargarProveedores();
        await cargarProductos();
      });

      async function cargarProveedores() {
        try {
          const res = await fetch("/api/proveedores");
          const proveedores = await res.json();
          const select = document.getElementById("id_proveedor");

          select.innerHTML =
            '<option value="">Seleccione un proveedor</option>';

          proveedores.forEach((p) => {
            select.innerHTML += `<option value="${p.id_proveedor}">${p.nombre}</option>`;
          });
        } catch (error) {
          console.error("Error cargando proveedores:", error);
        }
      }

      async function cargarProductos() {
        try {
          const res = await fetch("/api/productos");
          productosCache = await res.json();

          const selectInicial = document.querySelector(
            "select[name='id_producto[]']",
          );
          llenarSelectProductos(selectInicial);
        } catch (error) {
          console.error("Error cargando productos:", error);
        }
      }

      function llenarSelectProductos(select) {
        select.innerHTML = '<option value="">Seleccione producto</option>';
        productosCache.forEach((prod) => {
          select.innerHTML += `<option value="${prod.id_producto}">${prod.nombre_producto}</option>`;
        });
      }

      // --- FUNCIONES DE TABLA ---

      function agregarFila() {
        const tbody = document.querySelector("#tabla-detalle tbody");

        const nuevaFila = tbody.rows[0].cloneNode(true);

        nuevaFila.querySelectorAll("input").forEach((i) => (i.value = ""));
        nuevaFila
          .querySelectorAll(".error-msg")
          .forEach((div) => (div.style.display = "none"));
        nuevaFila
          .querySelectorAll(".input-error")
          .forEach((i) => i.classList.remove("input-error"));

        const selectProd = nuevaFila.querySelector(
          "select[name='id_producto[]']",
        );
        llenarSelectProductos(selectProd);

        tbody.appendChild(nuevaFila);
      }

      function eliminarFila(boton) {
        const tbody = document.querySelector("#tabla-detalle tbody");
        if (tbody.rows.length > 1) {
          boton.closest("tr").remove();
          calcularTotal();
        } else {
          alert("La cotizaci贸n debe tener al menos un producto.");
        }
      }

      async function buscarRequisicion() {
        const idReq = document
          .getElementById("id_requisicion_search")
          .value.trim();
        const tbody = document.querySelector("#tabla-detalle tbody");

        if (!idReq) {
          alert("Por favor escribe un n煤mero de requisici贸n.");
          return;
        }

        try {
          const res = await fetch(`/api/requisiciones/${idReq}`);
          if (!res.ok) throw new Error("No se encontr贸 esa requisici贸n.");

          const datos = await res.json();
          const tbody = document.querySelector("#tabla-detalle tbody");
          tbody.innerHTML = "";

          if (!datos.detalles || datos.detalles.length === 0) {
            alert("La requisici贸n no tiene productos.");
            return;
          }

          datos.detalles.forEach((item) => {
            const fila = document.createElement("tr");

            fila.innerHTML = `
                    <td>
                        <input type="hidden" name="id_producto[]" value="${item.id_producto}">
                        
                        <input type="text" class="input-texto" value="${item.nombre_producto}" 
                               readonly style="background-color: #e9ecef; border: 1px solid #ced4da;">
                    </td>
                    <td>
                        <input type="number" name="cantidad[]" class="input-numero" 
                               value="${item.cantidad}" readonly 
                               style="background-color: #e9ecef; text-align: center;">
                    </td>
                    <td>
                        <input type="number" name="precio_unitario[]" class="input-numero" 
                               step="0.01" min="0.01" placeholder="0.00" 
                               oninput="calcularTotal()" required
                               style="border: 2px solid #28a745;"> <div class="error-msg"></div>
                    </td>
                    <td>
                        <input type="hidden" name="unidad_medida[]" value="${item.unidad_medida}">
                        
                        <button type="button" onclick="eliminarFila(this)" title="El proveedor no tiene este 铆tem">
                            
                        </button>
                    </td>
                `;
            tbody.appendChild(fila);
          });

          document.getElementById("error_tabla").style.display = "none";
          alert("Requisicion cargada correctamente.");
        } catch (error) {
          console.error(error);
          alert(" " + error.message);
          tbody.innerHTML =
            '<tr><td colspan="4" style="text-align:center; color:red">Intente con otro n煤mero.</td></tr>';
        }
      }

      function calcularTotal() {
        let total = 0;
        const filas = document.querySelectorAll("#tabla-detalle tbody tr");

        filas.forEach((fila) => {
          const cant = parseFloat(
            fila.querySelector("[name='cantidad[]']").value,
          );
          const precio = parseFloat(
            fila.querySelector("[name='precio_unitario[]']").value,
          );

          if (!isNaN(cant) && !isNaN(precio)) {
            total += cant * precio;
          }
        });

        document.getElementById("monto_total").value = total.toFixed(2);
      }

      // --- GUARDAR EN BASE DE DATOS ---

      async function guardarCotizacion() {
        if (!validarCotizacion()) return;

        const datos = {
          id_requisicion: document
            .getElementById("id_requisicion_search")
            .value.trim(),
          id_proveedor: document.getElementById("id_proveedor").value,
          fecha_cotizacion: document.getElementById("fecha_cotizacion").value,
          validez: document.getElementById("validez").value,
          monto_total: document.getElementById("monto_total").value,
          detalles: [],
        };

        // Armar los Detalles (Tabla)
        const filas = document.querySelectorAll("#tabla-detalle tbody tr");
        filas.forEach((fila) => {
          const idProd = fila.querySelector("[name='id_producto[]']").value;
          const cant = fila.querySelector("[name='cantidad[]']").value;
          const precio = fila.querySelector("[name='precio_unitario[]']").value;

          if (idProd && cant && precio) {
            datos.detalles.push({
              id_producto: idProd,
              cantidad: cant,
              precio_unitario: precio,
            });
          }
        });

        if (datos.detalles.length === 0) {
          alert("No hay productos v谩lidos en la cotizaci贸n.");
          return;
        }

        // Enviar al Servidor
        try {
          const respuesta = await fetch("/api/cotizaciones", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(datos),
          });

          const resultado = await respuesta.json();

          if (respuesta.ok) {
            alert(" " + resultado.mensaje);

            document.getElementById("form-cotizacion").reset();

            document.querySelector("#tabla-detalle tbody").innerHTML =
              '<tr><td colspan="4" style="text-align:center; color:#666;">Busque una nueva requisici贸n...</td></tr>';

            if (document.getElementById("monto_total_display")) {
              document.getElementById("monto_total_display").innerText = "0.00";
            }
            document.getElementById("monto_total").value = "0.00";
          } else {
            alert(" ERROR DEL SERVIDOR: " + resultado.mensaje);
          }
        } catch (error) {
          console.error("El error real es:", error);
          alert(
            "Ocurri贸 un error (ver consola). Puede que los datos s铆 se hayan guardado.",
          );
        }
      }

      // --- VALIDACIN ---

      function mostrarErrorFila(input, mensaje) {
        input.classList.add("input-error");
        const divError = input.parentElement.querySelector(".error-msg");
        if (divError) {
          divError.innerText = mensaje;
          divError.style.display = "block";
        }
      }

      function validarCotizacion() {
        limpiarErrores();
        let esValido = true;

        // 1. VALIDAR CABECERA
        const idRequisicion = document
          .getElementById("id_requisicion_search")
          .value.trim();
        const idProveedor = document.getElementById("id_proveedor").value;
        const fecha = document.getElementById("fecha_cotizacion").value;
        const validez = document.getElementById("validez").value;

        // Requisici贸n
        if (esVacio(idRequisicion)) {
          mostrarError(
            "id_requisicion_search",
            "error_requisicion",
            "El n煤mero de requisici贸n es obligatorio.",
          );
          esValido = false;
        } else if (!esSoloNumeros(idRequisicion)) {
          mostrarError(
            "id_requisicion_search",
            "error_requisicion",
            "El ID debe ser num茅rico.",
          );
          esValido = false;
        }

        // Proveedor
        if (esVacio(idProveedor)) {
          mostrarError(
            "id_proveedor",
            "error_proveedor",
            "Debe seleccionar un proveedor.",
          );
          esValido = false;
        }

        // --- VALIDAR FECHA DE COTIZACIN ---
        if (esVacio(fecha)) {
          mostrarError(
            "fecha_cotizacion",
            "error_fecha",
            "La fecha es obligatoria.",
          );
          esValido = false;
        } else if (!esFechaNoFutura(fecha)) {
          mostrarError(
            "fecha_cotizacion",
            "error_fecha",
            "La fecha del documento no puede ser futura.",
          );
          esValido = false;
        }

        // Validez
        if (esVacio(validez)) {
          mostrarError(
            "validez",
            "error_validez",
            "Los d铆as de validez son obligatorios.",
          );
          esValido = false;
        } else if (!esNumeroPositivo(validez)) {
          mostrarError(
            "validez",
            "error_validez",
            "Debe ser un n煤mero de d铆as v谩lido.",
          );
          esValido = false;
        }

        // 2. VALIDAR DETALLES
        const filas = document.querySelectorAll("#tabla-detalle tbody tr");
        const errorTabla = document.getElementById("error_tabla");

        if (filas.length === 0) {
          errorTabla.innerText = "Agregue productos a la cotizaci贸n.";
          errorTabla.style.display = "block";
          esValido = false;
        } else {
          filas.forEach((fila) => {
            const inputProd = fila.querySelector("[name='id_producto[]']");
            const inputCant = fila.querySelector("[name='cantidad[]']");
            const inputPrecio = fila.querySelector(
              "[name='precio_unitario[]']",
            );

            if (
              esVacio(inputProd.value) ||
              esVacio(inputCant.value) ||
              !esNumeroPositivo(inputCant.value) ||
              esVacio(inputPrecio.value) ||
              !esNumeroPositivo(inputPrecio.value)
            ) {
              esValido = false;

              errorTabla.innerText =
                "Verifique que todos los productos tengan cantidad y precio mayor a cero.";
              errorTabla.style.display = "block";
            }
          });
        }

        const montoTotal = parseFloat(
          document.getElementById("monto_total").value,
        );

        if (isNaN(montoTotal) || montoTotal <= 0) {
          mostrarError(
            "monto_total",
            "error_monto_total",
            "El monto total no puede ser 0.",
          );
          esValido = false;
        }

        const idReq = document.getElementById("id_requisicion_search").value;
        const idProv = document.getElementById("id_proveedor").value;
        if (!idReq || !idProv) esValido = false;
        return esValido;
      }
    </script>
  </body>
</html>
