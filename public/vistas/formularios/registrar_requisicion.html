<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Registrar Requisici√≥n</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <style>
    td {
      vertical-align: top;
    }

    td .error-msg {
      font-size: 0.75em;
      margin-top: 2px;
    }
  </style>
</head>

<body>
  <a href="../formularios/menu_principal.html" class="btn-regresar">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 12H5M12 19l-7-7 7-7" />
    </svg>
    Regresar al Men√∫ Principal
  </a>
  <form id="form-requisicion" class="container" novalidate>
    <h1 id="titulo-form">Registrar Requisici√≥n</h1>
    <input type="hidden" id="id_requisicion_edit" value="" />

    <div class="form-group">
      <label for="id_usuario">Usuario solicitante </label>
      <input type="text" id="id_usuario" name="id_usuario" maxlength="10" placeholder="Ingrese c√©dula" required />
      <div id="error_usuario" class="error-msg"></div>
    </div>

    <div class="form-group">
      <label for="fecha">Fecha de requisici√≥n</label>
      <input type="date" id="fecha" name="fecha" required />
      <div id="error_fecha" class="error-msg"></div>
    </div>

    <div class="form-group">
      <label for="estado">Estado</label>
      <select id="estado" name="estado" required>
        <option value="">Seleccione</option>
        <option value="Pendiente">Pendiente</option>
        <option value="Aprobada">Aprobada</option>
        <option value="En proceso">En proceso</option>
        <option value="Atendida">Atendida</option>
        <option value="Rechazada">Rechazada</option>
      </select>
      <div id="error_estado" class="error-msg"></div>
    </div>

    <div class="form-group">
      <label for="justificacion">Justificaci√≥n</label>
      <textarea id="justificacion" name="justificacion"></textarea>
      <div id="error_justificacion" class="error-msg"></div>
    </div>

    <h2>Detalle de Requisici√≥n</h2>

    <div id="error_tabla" class="error-msg" style="margin-bottom: 10px"></div>

    <table id="tabla-detalle">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Unidad Medida</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <select name="id_producto[]" class="input-texto" required onchange="actualizarUnidad(this)">
              <option value="">Seleccione producto</option>
            </select>
            <div class="error-msg"></div>
          </td>
          <td>
            <input type="number" name="cantidad[]" min="1" class="input-numero" required />
            <div class="error-msg"></div>
          </td>
          <td>
            <input type="text" name="unidad_medida[]" class="input-texto" readonly placeholder="Autom√°tico"
              style="background-color: #f0f0f0; cursor: not-allowed" />
            <div class="error-msg"></div>
          </td>
          <td>
            <button type="button" onclick="eliminarFila(this)">üóë</button>
          </td>
        </tr>
      </tbody>
    </table>

    <button type="button" class="btn-secondary" onclick="agregarFila()">
      ‚ûï Agregar producto
    </button>
    <br /><br />

    <div class="grupo-botones">
      <button type="button" id="btn-principal" class="btn-guardar" onclick="guardarRequisicion()">
        <svg viewBox="0 0 24 24" width="20" height="20" style="vertical-align: middle; margin-right: 5px">
          <path fill="currentColor"
            d="M19,21H5V9H19M6,2H18V6H6M17,3H7V5H17M19,2H5A2,2 0 0,0 3,4V20A2,2 0 0,0 5,22H19A2,2 0 0,0 21,20V4A2,2 0 0,0 19,2Z" />
        </svg>
        <span id="texto-boton">Guardar Requisici√≥n</span>
      </button>
      <button type="button" id="btn-cancelar" class="btn-cancelar"
        onclick="window.location.href='consultar_requisiciones.html'" style="display: none;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
          stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        Cancelar Edici√≥n
      </button>
    </div>
  </form>

  <script src="../js/validaciones.js"></script>

  <script>
    // --- FUNCIONES DE TABLA ---
    let listaProductosCache = [];

    document.addEventListener("DOMContentLoaded", async () => {
      await cargarProductosEnSelects();
      const fechaInput = document.getElementById("fecha");
      const hoy = new Date();

      const anio = hoy.getFullYear();
      const mes = String(hoy.getMonth() + 1).padStart(2, '0');
      const dia = String(hoy.getDate()).padStart(2, '0');

      fechaInput.value = `${anio}-${mes}-${dia}`;
    });

    async function cargarProductosEnSelects() {
      try {
        const res = await fetch("/api/productos");
        listaProductosCache = await res.json();

        const selectInicial = document.querySelector(
          "select[name='id_producto[]']",
        );
        llenarSelect(selectInicial);
      } catch (error) {
        console.error("Error cargando productos:", error);
      }
    }

    function llenarSelect(selectElement) {
      selectElement.innerHTML =
        '<option value="">Seleccione producto</option>';
      listaProductosCache.forEach((prod) => {
        selectElement.innerHTML += `<option value="${prod.id_producto}">${prod.nombre_producto}</option>`;
      });
    }

    function actualizarUnidad(selectProducto) {
      const idSeleccionado = selectProducto.value;
      const producto = listaProductosCache.find(
        (p) => p.id_producto == idSeleccionado,
      );

      if (producto) {
        const fila = selectProducto.closest("tr");
        const inputUnidad = fila.querySelector(
          "input[name='unidad_medida[]']",
        );

        if (producto) {
          inputUnidad.value = producto.unidad_medida;
        } else {
          inputUnidad.value = "";
        }
      }
    }

    // AGREGAR FILA
    function agregarFila() {
      const tbody = document.querySelector("#tabla-detalle tbody");

      const primeraFila = tbody.rows[0];
      const nuevaFila = primeraFila.cloneNode(true);

      nuevaFila.querySelectorAll("input").forEach((i) => (i.value = ""));
      nuevaFila.querySelectorAll("select").forEach((s) => (s.value = ""));
      nuevaFila
        .querySelectorAll(".error-msg")
        .forEach((e) => (e.style.display = "none"));
      nuevaFila
        .querySelectorAll(".input-error")
        .forEach((i) => i.classList.remove("input-error"));

      const selectProd = nuevaFila.querySelector(
        "select[name='id_producto[]']",
      );
      llenarSelect(selectProd);

      tbody.appendChild(nuevaFila);
    }

    function eliminarFila(btn) {
      const tbody = document.querySelector("#tabla-detalle tbody");
      if (tbody.rows.length > 1) {
        btn.closest("tr").remove();
      } else {
        alert("Debe mantener al menos un producto.");
      }
    }

    // --- VALIDACI√ìN ---

    function mostrarErrorFila(elementoInput, mensaje) {
      elementoInput.classList.add("input-error");
      const padre = elementoInput.parentElement;
      const divError = padre.querySelector(".error-msg");
      if (divError) {
        divError.innerText = mensaje;
        divError.style.display = "block";
      }
    }

    function validarRequisicion() {
      limpiarErrores();
      let esValido = true;

      // 1. VALIDAR CABECERA
      const idUsuario = document.getElementById("id_usuario").value.trim();
      const fecha = document.getElementById("fecha").value;
      const estado = document.getElementById("estado").value;
      const justificacion = document
        .getElementById("justificacion")
        .value.trim();

      // Usuario
      if (esVacio(idUsuario)) {
        mostrarError(
          "id_usuario",
          "error_usuario",
          "El usuario solicitante es obligatorio.",
        );
        esValido = false;
      } else if (!esCedulaEcuatoriana(idUsuario)) {
        mostrarError(
          "id_usuario",
          "error_usuario",
          "Ingrese una c√©dula de usuario v√°lida.",
        );
        esValido = false;
      }

      // --- VALIDAR FECHA DE REQUISICI√ìN ---
      if (esVacio(fecha)) {
        mostrarError("fecha", "error_fecha", "La fecha es obligatoria.");
        esValido = false;
      } else if (!esFechaNoFutura(fecha)) {
        mostrarError("fecha", "error_fecha", "La fecha no puede ser futura.");
        esValido = false;
      }

      // Estado
      if (esVacio(estado)) {
        mostrarError(
          "estado",
          "error_estado",
          "Debe seleccionar un estado para la requisici√≥n.",
        );
        esValido = false;
      }

      // Justificaci√≥n
      if (esVacio(justificacion)) {
        mostrarError(
          "justificacion",
          "error_justificacion",
          "La justificaci√≥n es obligatoria.",
        );
        esValido = false;
      }

      // VALIDAR TABLA
      const filas = document.querySelectorAll("#tabla-detalle tbody tr");
      const errorTabla = document.getElementById("error_tabla");

      if (filas.length === 0) {
        errorTabla.innerText =
          "Debe agregar al menos un producto a la lista.";
        errorTabla.style.display = "block";
        esValido = false;
      } else {
        filas.forEach((fila) => {
          const inputProd = fila.querySelector("[name='id_producto[]']");
          const inputCant = fila.querySelector("[name='cantidad[]']");
          const inputUnidad = fila.querySelector("[name='unidad_medida[]']");

          if (esVacio(inputProd.value)) {
            mostrarErrorFila(inputProd, "Seleccione producto");
            esValido = false;
          }

          if (esVacio(inputCant.value)) {
            mostrarErrorFila(inputCant, "Requerido");
            esValido = false;
          } else if (!esNumeroPositivo(inputCant.value)) {
            mostrarErrorFila(inputCant, "Mayor a 0");
            esValido = false;
          }

          if (esVacio(inputUnidad.value)) {
            mostrarErrorFila(inputUnidad, "Requerido");
            esValido = false;
          }
        });
      }

      return esValido;
    }

    // GUARDAR TODO (Maestro + Detalle)
    async function guardarRequisicion() {
      if (!validarRequisicion()) return;

      const idEdit = document.getElementById("id_requisicion_edit").value;

      // A. Capturar Cabecera
      const cabecera = {
        id_usuario: document.getElementById("id_usuario").value.trim(),
        fecha: document.getElementById("fecha").value,
        estado: document.getElementById("estado").value,
        justificacion: document.getElementById("justificacion").value.trim(),
        detalles: [],
      };

      // B. Capturar Tabla (Detalles)
      const filas = document.querySelectorAll("#tabla-detalle tbody tr");
      filas.forEach((fila) => {
        const idProd = fila.querySelector(
          "select[name='id_producto[]']",
        ).value;
        const cant = fila.querySelector("input[name='cantidad[]']").value;
        const unidad = fila.querySelector("[name='unidad_medida[]']").value;

        if (idProd && cant) {
          cabecera.detalles.push({
            id_producto: idProd,
            cantidad: cant,
            unidad_medida: unidad,
          });
        }
      });

      const url = idEdit ? `/api/requisiciones/${idEdit}` : "/api/requisiciones";
      const metodo = idEdit ? "PUT" : "POST";

      // C. Enviar al Servidor
      try {
        const respuesta = await fetch(url, {
          method: metodo,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(cabecera),
        });

        const resultado = await respuesta.json();

        if (respuesta.ok) {
          alert("" + resultado.mensaje);
          window.location.href = "consultar_requisiciones.html";
        } else {
          if (resultado.mensaje.toLowerCase().includes("c√©dula") || resultado.mensaje.toLowerCase().includes("usuario")) {
            mostrarError("id_usuario", "error_usuario", resultado.mensaje);
            document.getElementById("id_usuario").scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById("id_usuario").focus();
          } else {
            alert("ERROR: " + resultado.mensaje);
          }
        }
      } catch (error) {
        console.error("Error REAL en consola:", error);
        alert("Error de conexi√≥n con el servidor.");
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await cargarProductosEnSelects();

      const params = new URLSearchParams(window.location.search);
      const idReq = params.get("id");

      if (idReq) {
        prepararModoEdicion(idReq);
      }
    });

    async function prepararModoEdicion(id) {
      try {
        const res = await fetch(`/api/requisiciones/${id}`);
        const data = await res.json();

        if (!res.ok) throw new Error(data.mensaje);

        // 1. Cambiar Interfaz
        document.getElementById("id_requisicion_edit").value = id;
        document.getElementById("titulo-form").innerText = `Editando Requisici√≥n #${id}`;
        document.getElementById("texto-boton").innerText = "Actualizar Requisici√≥n";
        document.getElementById("btn-cancelar").style.display = "inline-flex";
        document.getElementById("form-requisicion").classList.add("editando");

        // 2. Llenar Cabecera
        const inputUsuario = document.getElementById("id_usuario");
        inputUsuario.value = data.id_usuario;
        inputUsuario.readOnly = true;
        inputUsuario.style.backgroundColor = "#f0f0f0";
        inputUsuario.style.cursor = "not-allowed";
        document.getElementById("fecha").value = data.fecha.split("T")[0];
        document.getElementById("estado").value = data.estado;
        document.getElementById("justificacion").value = data.justificacion;

        // 3. Llenar Tabla de Detalles
        const tbody = document.querySelector("#tabla-detalle tbody");
        tbody.innerHTML = "";

        data.detalles.forEach((item) => {
          agregarFilaConDatos(item);
        });

      } catch (error) {
        alert("Error al cargar datos: " + error.message);
        window.location.href = "consultar_requisiciones.html";
      }
    }

    // Funci√≥n auxiliar para crear filas con datos ya existentes
    function agregarFilaConDatos(item) {
      const tbody = document.querySelector("#tabla-detalle tbody");
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>
            <select name="id_producto[]" class="input-texto" required onchange="actualizarUnidad(this)">
                ${listaProductosCache.map(p => `<option value="${p.id_producto}" ${p.id_producto == item.id_producto ? 'selected' : ''}>${p.nombre_producto}</option>`).join('')}
            </select>
            <div class="error-msg"></div>
        </td>
        <td>
            <input type="number" name="cantidad[]" value="${item.cantidad}" min="1" class="input-numero" required />
            <div class="error-msg"></div>
        </td>
        <td>
            <input type="text" name="unidad_medida[]" value="${item.unidad_medida}" class="input-texto" readonly style="background-color: #f0f0f0; cursor: not-allowed" />
            <div class="error-msg"></div>
        </td>
        <td>
            <button type="button" onclick="eliminarFila(this)"style="background: #ff7675; color: white; border:none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                ‚úï</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    function limpiarFormularioCompleto() {
      document.getElementById("form-requisicion").reset();
      const tbody = document.querySelector("#tabla-detalle tbody");

      while (tbody.rows.length > 1) {
        tbody.deleteRow(tbody.rows.length - 1);
      }

      const filaUno = tbody.rows[0];
      filaUno.querySelectorAll("input, textarea, select").forEach(el => el.value = "");
      filaUno.querySelectorAll(".error-msg").forEach(e => e.style.display = "none");
      filaUno.querySelectorAll(".input-error").forEach(e => e.classList.remove("input-error"));
    }
  </script>
</body>

</html>