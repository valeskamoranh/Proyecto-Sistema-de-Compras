<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Gesti√≥n de √Årea</title>
  <link rel="stylesheet" href="../css/styles.css" />
</head>

<body>
  <a href="../formularios/menu_principal.html" class="btn-regresar">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 12H5M12 19l-7-7 7-7" />
    </svg>
    Regresar al Men√∫ Principal
  </a>

  <form id="form-area" class="container">
    <h1 id="titulo-form">Registrar √Årea</h1>
    <input type="hidden" id="id_area_edit" value="" />
    <div class="form-group">
      <label for="nombre_area">Nombre del √°rea</label>
      <input type="text" id="nombre_area" name="nombre_area" />
      <div id="error_nombre" class="error-msg"></div>
    </div>

    <div class="form-group">
      <label for="responsable">Responsable</label>
      <input type="text" id="responsable" name="responsable" />
      <div id="error_responsable" class="error-msg"></div>
    </div>

    <div class="grupo-botones">
      <button type="button" class="btn-guardar" onclick="guardarArea()">
        <svg viewBox="0 0 24 24" width="20" height="20" style="vertical-align: middle; margin-right: 5px">
          <path fill="currentColor"
            d="M19,21H5V9H19M6,2H18V6H6M17,3H7V5H17M19,2H5A2,2 0 0,0 3,4V20A2,2 0 0,0 5,22H19A2,2 0 0,0 21,20V4A2,2 0 0,0 19,2Z" />
        </svg>
        <span id="texto-boton">Guardar</span>
      </button>
      <button type="button" id="btn-cancelar" class="btn-cancelar" onclick="resetForm()" style="display: none">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
          stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        Cancelar Edici√≥n
      </button>
    </div>
  </form>

  <div class="container container-tabla">
    <h1>√Åreas Registradas</h1>

    <div class="busqueda-container">
      <div class="busqueda-input-wrapper">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#636e72" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" id="input-busqueda" placeholder="Buscar √°rea o responsable..." onkeyup="filtrarTabla()" />
      </div>
    </div>

    <table id="tabla-areas">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre del √Årea</th>
          <th>Responsable</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="lista-areas"></tbody>
    </table>
  </div>

  <script src="../js/validaciones.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", cargarAreas);
    async function cargarAreas() {
      try {
        const res = await fetch("/api/areas");
        const areas = await res.json();
        const tbody = document.getElementById("lista-areas");
        tbody.innerHTML = "";

        areas.forEach((a) => {
          tbody.innerHTML += `
                        <tr>
                            <td>${a.id_area}</td>
                            <td>${a.nombre_area}</td>
                            <td>${a.responsable || "No asignado"}</td>
                            <td class="acciones">
                                <button class="btn-edit" onclick="prepararEdicion(${a.id_area}, '${a.nombre_area}', '${a.responsable || ""}')">‚úèÔ∏è</button>
                                <button class="btn-delete" onclick="eliminarArea(${a.id_area})">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
        });
      } catch (error) {
        console.error("Error al cargar:", error);
      }
    }

    function prepararEdicion(id, nombre, responsable) {
      document.getElementById("id_area_edit").value = id;
      document.getElementById("nombre_area").value = nombre;
      document.getElementById("responsable").value = responsable;

      document.getElementById("titulo-form").innerText =
        "Editando √Årea #" + id;
      document.getElementById("texto-boton").innerText = "Actualizar Cambios";
      document.getElementById("btn-cancelar").style.display = "block";
      document.getElementById("form-area").classList.add("editando");

      window.scrollTo({
        top: 0,
        behavior: "smooth",
      });
    }

    async function eliminarArea(id) {
      if (!confirm(`¬øEst√°s seguro de eliminar el √°rea #${id}?`)) return;
      try {
        const res = await fetch(`/api/areas/${id}`, { method: "DELETE" });
        const result = await res.json();
        alert(result.mensaje);
        cargarAreas();
      } catch (error) {
        alert("No se pudo eliminar el √°rea.");
      }
    }

    function resetForm() {
      const formulario = document.getElementById("form-area");
      formulario.reset();
      document.getElementById("id_area_edit").value = "";
      document.getElementById("titulo-form").innerText = "Registrar √Årea";
      document.getElementById("texto-boton").innerText = "Guardar";
      document.getElementById("btn-cancelar").style.display = "none";
      formulario.classList.remove("editando");
      if (typeof limpiarErrores === "function") limpiarErrores();
    }

    function validarArea() {
      if (typeof limpiarErrores === "function") limpiarErrores();

      let esValido = true;

      const nombreInput = document.getElementById("nombre_area");
      const responsableInput = document.getElementById("responsable");

      const nombre = nombreInput.value;
      const responsable = responsableInput.value;

      // --- Validar Nombre ---
      if (esVacio(nombre)) {
        mostrarError(
          "nombre_area",
          "error_nombre",
          "El nombre es obligatorio.",
        );
        esValido = false;
      } else if (!esSoloTexto(nombre)) {
        mostrarError(
          "nombre_area",
          "error_nombre",
          "Solo se permiten letras.",
        );
        esValido = false;
      } else if (!cumpleLongitudMinima(nombre, 3)) {
        mostrarError("nombre_area", "error_nombre", "M√≠nimo 3 caracteres.");
        esValido = false;
      }

      // --- Validar Responsable ---
      if (esVacio(responsable)) {
        mostrarError(
          "responsable",
          "error_responsable",
          "El responsable es obligatorio.",
        );
        esValido = false;
      } else if (!esSoloTexto(responsable)) {
        mostrarError(
          "responsable",
          "error_responsable",
          "Solo se permiten letras.",
        );
        esValido = false;
      } else if (!cumpleLongitudMinima(responsable, 3)) {
        mostrarError("responsable", "error_responsable", "Nombre muy corto.");
        esValido = false;
      }

      return esValido;
    }

    async function guardarArea() {
      if (!validarArea()) {
        return;
      }

      const id = document.getElementById("id_area_edit").value;
      const datosAEnviar = {
        nombre_area: document.getElementById("nombre_area").value.trim(),
        responsable: document.getElementById("responsable").value.trim(),
      };

      const metodo = id ? "PUT" : "POST";
      const url = id ? `/api/areas/${id}` : "/api/areas";
      try {
        const respuesta = await fetch(url, {
          method: metodo,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datosAEnviar),
        });

        if (respuesta.ok) {
          let mensajeExito = "Operaci√≥n realizada correctamente";
          try {
            const resultado = await respuesta.json();
            mensajeExito = resultado.mensaje;
          } catch (e) {
            console.log(
              "El servidor no envi√≥ un JSON, pero la DB se actualiz√≥.",
            );
          }

          alert("" + mensajeExito);
          resetForm();
          cargarAreas();
        } else {
          const errorData = await respuesta
            .json()
            .catch(() => ({ mensaje: "Error desconocido en el servidor" }));
          alert("ERROR: " + errorData.mensaje);
        }
      } catch (error) {
        console.error("Error t√©cnico:", error);
        alert(
          "Los cambios se enviaron, pero hubo un problema al confirmar. Por favor, revisa la tabla.",
        );
        cargarAreas();
      }
    }

    function filtrarTabla() {
      const texto = document
        .getElementById("input-busqueda")
        .value.toLowerCase();
      const filas = document.querySelectorAll("#lista-areas tr");

      filas.forEach((fila) => {
        const nombreArea = fila.cells[1]
          ? fila.cells[1].textContent.toLowerCase()
          : "";
        const responsable = fila.cells[2]
          ? fila.cells[2].textContent.toLowerCase()
          : "";

        if (nombreArea.includes(texto) || responsable.includes(texto)) {
          fila.style.display = "";
        } else {
          fila.style.display = "none";
        }
      });
    }
  </script>
</body>

</html>