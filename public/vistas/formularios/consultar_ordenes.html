<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Listado de Ã“rdenes de Compra</title>
  <link rel="stylesheet" href="../css/styles.css" />
</head>

<body>
  <a href="../formularios/menu_principal.html" class="btn-regresar">â¬… Regresar</a>

  <div class="container" style="max-width: 1000px">
    <h1>Ã“rdenes de Compra Registradas</h1>

    <div class="busqueda-container" style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
      <div class="busqueda-input-wrapper"
        style="position: relative; display: flex; align-items: center; background: white; border: 1px solid #dfe6e9; border-radius: 8px; padding: 0 12px; width: 300px;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#636e72" stroke-width="2"
          style="margin-right: 8px;">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" id="input-busqueda" placeholder="Buscar por NÂ° OC, CotizaciÃ³n o Estado..."
          onkeyup="filtrarTabla()" style="border: none; padding: 10px 0; outline: none; width: 100%;">
      </div>
    </div>

    <div class="filtros-container" style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px;">
      <div>
        <label>Desde:</label>
        <input type="date" id="filtro-inicio" class="input-tabla">
      </div>
      <div>
        <label>Hasta:</label>
        <input type="date" id="filtro-fin" class="input-tabla">
      </div>
      <button onclick="cargarOrdenes()" class="btn-ver" style="padding: 8px 20px;">Filtrar</button>
      <button onclick="limpiarFiltros()"
        style="background:none; border:none; color:blue; cursor:pointer;">Limpiar</button>
      <button onclick="exportarReportePDF()" class="btn-pdf" style="background-color: #e74c3c; color: white;">
        ðŸ“¥ Descargar Reporte PDF
      </button>
    </div>

    <table id="tabla-listado">
      <thead>
        <tr>
          <th>NÂ° OC</th>
          <th>NÂ° CotizaciÃ³n</th>
          <th>Fecha EmisiÃ³n</th>
          <th>Items</th>
          <th>Monto Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="lista-ordenes"></tbody>
    </table>
  </div>

  <div id="modal-detalle" class="modal" style="
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      ">
    <div style="
          background-color: white;
          margin: 5% auto;
          padding: 20px;
          border-radius: 8px;
          width: 70%;
          max-width: 800px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        ">
      <span onclick="cerrarModal()" style="
            float: right;
            cursor: pointer;
            font-size: 28px;
            font-weight: bold;
          ">&times;</span>
      <h2 id="modal-titulo">Detalle de la Orden</h2>
      <hr />
      <div id="modal-info-general" style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
          "></div>
      <table style="width: 100%; border-collapse: collapse">
        <thead style="background: #f3f0fc; color: #5e2a84">
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unit.</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="modal-tabla-cuerpo"></tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", cargarOrdenes);

    async function cargarOrdenes() {
      const inicio = document.getElementById("filtro-inicio").value;
      const fin = document.getElementById("filtro-fin").value;

      let url = "/api/ordenes";
      if (inicio && fin) {
        url += `?inicio=${inicio}&fin=${fin}`;
      }

      try {
        const res = await fetch(url);
        const ordenes = await res.json();
        const tbody = document.getElementById("lista-ordenes");
        tbody.innerHTML = "";

        ordenes.forEach((o) => {
          const statusClass = `estado-${o.estado_OC.toLowerCase().replace(/\s+/g, "-")}`;
          const esAnulable = o.estado_OC === "Emitida";

          tbody.innerHTML += `
                        <tr>
                            <td><strong>${o.id_OC}</strong></td>
                            <td>#${o.id_cotizacion}</td>
                            <td>${new Date(o.fecha_emision).toLocaleDateString()}</td>
                            <td>${o.cantidad_items}</td>
                            <td>$${parseFloat(o.monto_total_OC).toFixed(2)}</td>
                            <td><span class="badge ${statusClass}">${o.estado_OC}</span></td>
                            <td>
                                <button class="btn-ver" onclick="verDetalle(${o.id_OC})">Ver</button>
                                <button class="btn-anular" 
                                        onclick="confirmarAnulacion(${o.id_OC})"
                                        ${!esAnulable ? "disabled" : ""}
                                        title="${esAnulable ? "Anular orden" : "Solo se pueden anular Ã³rdenes emitidas"}">
                                    Anular
                                </button>
                                <a href="/api/reportes/orden-compra/${o.id_OC}/pdf" target="_blank" class="btn btn-pdf">ðŸ“„ PDF </a>
                            </td>
                        </tr>
                    `;
        });
      } catch (error) {
        console.error("Error cargando Ã³rdenes:", error);
      }
    }

    function limpiarFiltros() {
      document.getElementById("filtro-inicio").value = "";
      document.getElementById("filtro-fin").value = "";
      cargarOrdenes();
    }

    function filtrarTabla() {
      const input = document.getElementById("input-busqueda");
      const filtro = input.value.toUpperCase();
      const tr = document.querySelectorAll("#lista-ordenes tr");

      tr.forEach(fila => {
        const tdId = fila.cells[0];
        const tdCot = fila.cells[1];
        const tdEstado = fila.cells[5];

        if (tdId && tdCot) {
          const texto = (tdId.textContent + tdCot.textContent + tdEstado.textContent).toUpperCase();
          fila.style.display = texto.includes(filtro) ? "" : "none";
        }
      });
    }

    async function confirmarAnulacion(id) {
      if (!confirm(`Â¿EstÃ¡ seguro de anular la Orden de Compra NÂ° ${id}?`))
        return;

      try {
        const res = await fetch(`/api/ordenes/anular/${id}`, {
          method: "PUT",
        });
        const resultado = await res.json();

        if (res.ok) {
          alert(resultado.mensaje);
          cargarOrdenes();
        } else {
          alert("Error: " + resultado.mensaje);
        }
      } catch (error) {
        alert("Error de conexiÃ³n.");
      }
    }

    async function verDetalle(id) {
      try {
        const res = await fetch(`/api/ordenes/${id}`);
        if (!res.ok) throw new Error("No se pudo obtener el detalle.");

        const data = await res.json();

        // 1. Llenar informacion general
        document.getElementById("modal-titulo").innerText =
          `Orden de Compra NÂ° ${data.id_OC}`;
        document.getElementById("modal-info-general").innerHTML = `
            <p><strong>NÂ° CotizaciÃ³n vinculada:</strong> #${data.id_cotizacion}</p>
            <p><strong>Fecha:</strong> ${new Date(data.fecha_emision).toLocaleDateString()}</p>
            <p><strong>Estado:</strong> ${data.estado_OC}</p>
            <p><strong>Total Unidades:</strong> ${data.total_unidades}</p>
            <p><strong>Monto Total:</strong> $${parseFloat(data.monto_total_OC).toFixed(2)}</p>
        `;

        // 2. Llenar tabla de productos
        const tbody = document.getElementById("modal-tabla-cuerpo");
        tbody.innerHTML = "";

        data.detalles.forEach((d) => {
          const subtotal = d.cantidad * d.precio_unitario;
          tbody.innerHTML += `
                <tr style="text-align: center; border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">${d.nombre_producto}</td>
                    <td>${d.cantidad}</td>
                    <td>$${parseFloat(d.precio_unitario).toFixed(2)}</td>
                    <td>$${subtotal.toFixed(2)}</td>
                </tr>
            `;
        });

        // 3. Mostrar Modal
        document.getElementById("modal-detalle").style.display = "block";
      } catch (error) {
        alert("Error: " + error.message);
      }
    }

    function cerrarModal() {
      document.getElementById("modal-detalle").style.display = "none";
    }

    window.onclick = function (event) {
      if (event.target == document.getElementById("modal-detalle")) cerrarModal();
    }

    function exportarReportePDF() {
      const inicio = document.getElementById("filtro-inicio").value;
      const fin = document.getElementById("filtro-fin").value;
      const busqueda = document.getElementById("input-busqueda").value;

      let url = `/api/ordenes/reporte-pdf?`;

      const params = new URLSearchParams();
      if (inicio) params.append("inicio", inicio);
      if (fin) params.append("fin", fin);
      if (busqueda) params.append("q", busqueda);

      url += params.toString();

      window.open(url, '_blank');
    }
  </script>
</body>

</html>